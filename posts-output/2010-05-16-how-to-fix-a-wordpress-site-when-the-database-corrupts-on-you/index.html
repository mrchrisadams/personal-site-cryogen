<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Chris Adams Blog: How to fix a Wordpress site when the database corrupts on you.</title>
        
<meta name="keywords" content="">

<meta name="description" content="Phew!">

<meta property="og:description" content="Phew!">

<meta property="og:url" content="http://blog.chrisadams.me.uk/posts-output/2010-05-16-how-to-fix-a-wordpress-site-when-the-database-corrupts-on-you/" />
<meta property="og:title" content="How to fix a Wordpress site when the database corrupts on you." />
<meta property="og:type" content="article" />

        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Oxygen:300,400,700|Inconsolata" rel="stylesheet">
        <link href="/css/normalize.css" rel="stylesheet" type="text/css" />
        <link href="/css/blog.css" rel="stylesheet" type="text/css" />
        <link href="/css/lotus-highlightjs.min.css" rel="stylesheet" type="text/css" />

    </head>
    <body>
        <aside id="sidebar">
            <div id="logo">
                <a title="Chris Adams Blog" href="/">
                <div class="text desktop-and-tablet-only">Chris Adams Blog</div>
                <div class="text mobile-only">Chris Adams Blog</div>
                </a>
            </div>

            <nav id="sidebar-links">
                <nav id="menucont">
                    <input type="checkbox" id="menu-checkbox" class="menu-checkbox">
                    <label for="menu-checkbox" class="menutitle">
                        <svg class="icon icon-menu" aria-hidden="true"><use xlink:href="/img/icons.svg#icon-menu"></use></svg><span class="menu-text">Menu</span>
                    </label>
                    <ul class="menu">
                        <li ><a title="Home" href="/"><div class="menu-item-text">Home</div></a></li>
                        <li ><a title="Archives" href="/archives/"><div class="menu-item-text">Archives</div></a></li>
                        
                        
                        <li >
                            <a href="/pages-output/about/"><div class="menu-item-text">About</div></a>
                        </li>
                        
                        <!-- <li><a title="RSS" href="/feed.xml"><div class="menu-item-text">RSS</div></a></li> -->
                    </ul>
                </nav>

                <nav id="socialmedia">
                    <ul>
                        <li><a title="LinkedIn" href="https://www.linkedin.com/in/mrchrisadams" rel="external"><svg class="icon icon-linkedin"><use xlink:href="/img/icons.svg#icon-linkedin"></use></svg></a></li>
                        <li><a title="GitHub" href="https://github.com/mrchrisadams" rel="external"><svg class="icon icon-github-circled"><use xlink:href="/img/icons.svg#icon-github-circled"></use></svg></a></li>
                        <li><a title="RSS Feed" href="/feed.xml"><svg class="icon icon-rss-squared"><use xlink:href="/img/icons.svg#icon-rss-squared"></use></svg></a></li>
                    </ul>
                </nav>
            </nav>
        </aside>

        <article id="main">
            
<div id="post">
    <div class="post-header">
    <div id="post-meta">
        <h1>How to fix a Wordpress site when the database corrupts on you.</h1>
        <div class="byline">
            <span class="date">May 16, 2010</span>
            
            <span class="author">By: admin</span>
            
        </div>
    </div>
</div>
<div>
    
    <!-- content below --><p>Phew!</p><p>... and as soon as I say this, the database powering this site corrupts on me - charming!</p><p>For one awful moment I thought I had lost everything (I hadn't set up a regular mysql backup task for this blog), but thankfully, bringing this blog back from the dead was surprisingly straight forward.</p><p>Here's what happened, and what I did to fix it.</p><p>Yesterday when writing a post about how there's a mobile missing tariff that should exist but doesn't, when I posted, <a href="http://wordpress.org" title="WordPress â€º Blog Tool and Publishing Platform">Wordpress</a> would accept my post; those pretty git spinners just kept spinning on the text page.</p><p>I didn't think too much of it, at the time, as I was heading out to meet James to work on some top sekrit project, based around <a href="http://nodejs.org/" title="node.js">node.js</a>, <a href="http://www.mongodb.org/" title="MongoDB">mongodb</a>, and doing something strange yet hopefully useful with wifi, so I just saved it locally on my mac, and headed out on my bike.</p><p>This evening though, I tried again, and I had the same error. "Ah," I thought, "maybe I just need to restart the database on this box - it's been going for ages anyway". So I ssh'd into the server running the system, and called the usual <a href="http://centos.org/" title="www.centos.org - The Community ENTerprise Operating System">CentOS</a> restart command</p><pre lang="bash">
  service mysql restart
</pre><p>This took nearly two minutes to stop, then spat out this response when restarting:</p><pre lang="bash">
[chris@stemcaa2 ~]# service mysql restart
Shutting down MySQL........................................[  OK  ].......
Starting MySQL.........................................................................................................................................................................................................................................../sbin/service: line 66: 27651 Terminated              env -i LANG="$LANG" PATH="$PATH" TERM="$TERM" "${SERVICEDIR}/${SERVICE}" ${OPTIONS}
</pre><p>Okay, slight panic now - lets check the disk, to see if there's space for the database to write, with <code>df -h</code></p><pre lang="bash">

[chris@stemcaa2 ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/sda1             9.9G  9.4G     0 100% /
tmpfs                 129M     0  129M   0% /dev/shm
/usr/tmpDSK           485M   11M  449M   3% /tmp

</pre><p>Ah, that's not good. Disk space is like oxygen for servers, and without it, things break quickly.</p><p>The quickest way to make some breathing space fast is to clear the <code>yum</code> cache, like so:</p><pre lang="bash">
yum clean headers packages
</pre><p>Okay, lets try restart again:</p><pre lang="bash">
[chris@stemcaa2 ~]# service mysql restart
Shutting down MySQL.                                       [  OK  ]
Starting MySQL.                                            [  OK  ]
</pre><p>Sweet! It worked! But hang on... now wordpress isn't showing any posts! This <em>really</em> isn't good.</p><p>So lets check the database;</p><pre lang="mysql">
[root@stemcaa2 ~]# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 11
Server version: 5.0.90-community MySQL Community Edition (GPL)

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema | 
| antia_wordpress    | 
| chris_wordpress    | 
| cphulkd            | 
| deadonim_wordpress | 
| dov_wordpress      | 
| eximstats          | 
| horde              | 
| leechprotect       | 
| modsec             | 
| mysql              | 
| roundcube          | 
+--------------------+
12 rows in set (0.16 sec)

</pre><p>Okay the database is there. What about the tables though?</p><pre lang="mysql">

Database changed
mysql&gt; show tables;
+---------------------------+
| Tables_in_chris_wordpress |
+---------------------------+
| wp_ak_twitter             | 
| wp_commentmeta            | 
| wp_comments               | 
| wp_links                  | 
| wp_options                | 
| wp_postmeta               | 
| wp_posts                  | 
| wp_term_relationships     | 
| wp_term_taxonomy          | 
| wp_terms                  | 
| wp_usermeta               | 
| wp_users                  | 
+---------------------------+
12 rows in set (0.00 sec)

</pre><p>Hmm.. they're there too. Maybe the tables?</p><pre lang="mysql">

mysql&gt; select * from wp_posts
    -&gt; ;
ERROR 145 (HY000): Table './chris_wordpress/wp_posts' is marked as crashed and should be repaired

</pre><p><em>Uh-oh.</em> I think this is going to be ugly. And yet...</p><h3 id="the-magic-fix">The magic fix</h3><p>...a quick check here on google gleaned the fix - MySQL's got a tool for just this occasion, and you call it like  <code>mysqlcheck broken_database</code> from the command line:</p><pre lang="mysql">
[root@stemcaa2 ~]# mysqlcheck chris_wordpress
chris_wordpress.wp_ak_twitter                      OK
chris_wordpress.wp_commentmeta                     OK
chris_wordpress.wp_comments                        OK
chris_wordpress.wp_links                           OK
chris_wordpress.wp_options                         OK
chris_wordpress.wp_postmeta                        OK
chris_wordpress.wp_posts
warning  : Table is marked as crashed
error    : Size of datafile is: 745472         Should be: 745692
error    : Corrupt
chris_wordpress.wp_term_relationships              OK
chris_wordpress.wp_term_taxonomy                   OK
chris_wordpress.wp_terms                           OK
chris_wordpress.wp_usermeta                        OK
chris_wordpress.wp_users                           OK

</pre><p>The fix was trivial from here - just pass in an <code>auto-repair</code> flag:</p><pre lang="mysql">

[root@stemcaa2 ~]# mysqlcheck chris_wordpress --auto-repair
chris_wordpress.wp_ak_twitter                      OK
chris_wordpress.wp_commentmeta                     OK
chris_wordpress.wp_comments                        OK
chris_wordpress.wp_links                           OK
chris_wordpress.wp_options                         OK
chris_wordpress.wp_postmeta                        OK
chris_wordpress.wp_posts
warning  : Table is marked as crashed
error    : Size of datafile is: 745472         Should be: 745692
error    : Corrupt
chris_wordpress.wp_term_relationships              OK
chris_wordpress.wp_term_taxonomy                   OK
chris_wordpress.wp_terms                           OK
chris_wordpress.wp_usermeta                        OK
chris_wordpress.wp_users                           OK

Repairing tables
chris_wordpress.wp_posts
info     : Found block that points outside data file at 742932
status   : OK

</pre><p>And then all was well again! Why can't technology always be this easy to fix?  A huge, huge heartfelt thanks goes to <a href="http://www.felipecruz.com/" title="Felipe's Blog - Technology Articles &amp; know how">Felipe Cruz</a> for adding <a href="http://www.felipecruz.com/repair-mysql-database.php" title="Ways to repair MYSQL Databases">such simple instructions on his site</a> explaining how to use that insanely handy <code>mysqlcheck</code> command.</p><!-- links -->
</div>

<br/>


    
    <div id="prev-next">
    
    <a class="prev" href="/posts-output/2010-05-17-tar-is-not-zip/"><svg class="icon icon-circle-left"><use xlink:href="/img/icons.svg#icon-circle-left"></use></svg><div class="nav-text">Tar is not zip</div></a>
    
    
    <a class="next" href="/posts-output/2010-05-16-not-quite-sure-what-im-doing-with-this-site/"><div class="nav-text"">Not quite sure what I&#39;m doing with this site</div><svg class="icon icon-circle-right"><use xlink:href="/img/icons.svg#icon-circle-right"></use></svg></a>
    
</div>

    

</div>

            <hr/>
            <div id="footercont">
                Copyright &copy; 2020 Chris Adams
                <br>Powered by <a href="http://cryogenweb.org">Cryogen</a>
                <br>Theme by <a href="http://github.com/KingMob">KingMob</a>
            </div>
        </article>

        <script src="/js/highlight.pack.js" type="text/javascript"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        
        
    </body>
</html>
