<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Chris Adams Blog: Avoiding that Face Palm moment with Logrotate</title>
        
<meta name="keywords" content="">

<meta name="description" content="A runaway log file brought down on a previously built Rails app I was involved in building recently, and the solution to the problem here is so simple and easy to implement that a) I feel like a total dunce for not having this setup here in the first place b) it&#39;s almost churlish not to list it here, for reference for someone else, in the hope that it saves them feeling this stupid themselves in the future, (oh, and keeps the site they&#39;re working on up...).">

<meta property="og:description" content="A runaway log file brought down on a previously built Rails app I was involved in building recently, and the solution to the problem here is so simple and easy to implement that a) I feel like a total dunce for not having this setup here in the first place b) it&#39;s almost churlish not to list it here, for reference for someone else, in the hope that it saves them feeling this stupid themselves in the future, (oh, and keeps the site they&#39;re working on up...).">

<meta property="og:url" content="http://blog.chrisadams.me.uk/posts-output/2010-05-10-avoiding-that-face-palm-moment-with-logrotate/" />
<meta property="og:title" content="Avoiding that Face Palm moment with Logrotate" />
<meta property="og:type" content="article" />

        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Oxygen:300,400,700|Inconsolata" rel="stylesheet">
        <link href="/css/normalize.css" rel="stylesheet" type="text/css" />
        <link href="/css/blog.css" rel="stylesheet" type="text/css" />
        <link href="/css/lotus-highlightjs.min.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <aside id="sidebar">
            <div id="logo">
                <a title="Chris Adams Blog" href="/">
                <div class="text desktop-and-tablet-only">Chris Adams Blog</div>
                <div class="text mobile-only">Chris Adams Blog</div>
                </a>
            </div>

            <nav id="sidebar-links">
                <nav id="menucont">
                    <input type="checkbox" id="menu-checkbox" class="menu-checkbox">
                    <label for="menu-checkbox" class="menutitle">
                        <svg class="icon icon-menu" aria-hidden="true"><use xlink:href="/img/icons.svg#icon-menu"></use></svg><span class="menu-text">Menu</span>
                    </label>
                    <ul class="menu">
                        <li ><a title="Home" href="/"><div class="menu-item-text">Home</div></a></li>
                        <li ><a title="Archives" href="/archives/"><div class="menu-item-text">Archives</div></a></li>
                        
                        
                        <li >
                            <a href="/pages-output/about/"><div class="menu-item-text">About</div></a>
                        </li>
                        
                        <!-- <li><a title="RSS" href="/feed.xml"><div class="menu-item-text">RSS</div></a></li> -->
                    </ul>
                </nav>

                <nav id="socialmedia">
                    <ul>
                        <li><a title="LinkedIn" href="https://www.linkedin.com/in/matthewdavidson1" rel="external"><svg class="icon icon-linkedin"><use xlink:href="/img/icons.svg#icon-linkedin"></use></svg></a></li>
                        <li><a title="GitHub" href="https://github.com/KingMob" rel="external"><svg class="icon icon-github-circled"><use xlink:href="/img/icons.svg#icon-github-circled"></use></svg></a></li>
                        <li><a title="RSS Feed" href="/feed.xml"><svg class="icon icon-rss-squared"><use xlink:href="/img/icons.svg#icon-rss-squared"></use></svg></a></li>
                    </ul>
                </nav>
            </nav>
        </aside>

        <article id="main">
            
<div id="post">
    <div class="post-header">
    <div id="post-meta">
        <h1>Avoiding that Face Palm moment with Logrotate</h1>
        <div class="byline">
            <span class="date">May 10, 2010</span>
            
            <span class="author">By: admin</span>
            
        </div>
    </div>
</div>
<div>
    
    <!-- content below --><p>A runaway log file brought down on a previously built Rails app I was involved in building recently, and the solution to the problem here is so simple and easy to implement that a) I feel like a total dunce for not having this setup here in the first place b) it's almost churlish not to list it here, for reference for someone else, in the hope that it saves them feeling this stupid themselves in the future, (oh, and keeps the site they're working on up...).</p><p>If you're not using Rail's own to rotate the log files it generates, it really is good idea to make sure any log files it <em>does</em> make are being rotated, to make sure you don't get caught out when that innocuous seeming <code>development.log</code> file from a few months back goes live ends up bringing down your site because it's since grown from a 6k file to a 7 gigiabyte one, and eaten all the space on your server.</p><p>Making sure this doesn't happen is a pretty simple process:</p><ul><li>Find where the offending logfiles are eating up all your disk space.</li><li>Create a new <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">logrotate</a> entry pointing to them.</li><li>Trigger the <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">logrotate</a> daemon to test it</li><li>Relax and get on with your life</li></ul><p>Okay lets run through this in more detail.</p><h4 id="find-the-offending-logfiles">Find the offending logfiles</h4><p>The first step here is to find where the logs are being created. This here is the cause of the problem on a lot of boxes running Rails apps, because if you're using Capistrano to deploy an app, and you're using a stock Passenger config then your logs will end up in somewhere that the <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">logrotate</a> daemon, the program that dutifully goes around compressing and sorting logfiles on your server, won't know where to look for by default.</p><p>Normally, you can expect to find these quietly ballooning log files somewhere like <code>/home/deploy/app/shared/log/</code>, or <code>/rails/deploy/appname.production/shared/log/</code>.</p><h4 id="create-the-new-logrotate-entry">Create the new logrotate entry</h4><p>Now that we know where the logs are that keep eating space, we can tell <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">logrotate</a> about them, to make sure they won't grow too large. Create a text file named <code>railsapp</code> (or whatever makes the most sense to you) in <code>/etc/logrotate.d/</code>, the default place to leave instructions for <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">logrotate</a> to follow:</p><pre lang="bash">

/home/deploy/app/shared/log/*.log {
  daily
  missingok
  rotate 30
  compress
  delaycompress
  sharedscripts
  postrotate
    touch /home/deploy/app/current/tmp/restart.txt
  endscript
}

</pre><p>Looking at that line by line:</p><ul><li><code>daily</code> calls this script daily</li><li><code>missingok</code> means it's okay if we're missing some log files, we'll still work without stopping</li><li><code>rotate 30</code> means keep the last 30 days of logs</li><li><code>compress</code> yup, compress the logs (using gzip by default)</li><li><code>delaycompress</code> means "wait til the next day before compressing this file, just incase there are still be processes writing to this logfile"</li><li><code>sharedscripts</code> means only call the next <code>postrotate</code> script once for all the files that match the pattern above, instead of restarting for each file</li><li><code>postrotate</code> ... <code>endscript</code> - this script here fires after a rotate, to restart the passenger server, so that future processes log to the fresh, empty logfile</li></ul><p>If you want to learn more, this article by <a href="http://overstimulate.com/articles/logrotate-rails-passenger" title="Log Rotation for Phusion Passenger | overstimulate">Jesse Andrews on how he uses it</a>  is an absolute gem.</p><h4 id="trigger-the-logrotate-daemon">Trigger the logrotate daemon</h4><p>Now that we have a <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">logrotate</a> entry, lets check it if works now rather than going to bed and finding out we had mistyped the path, by <em>forcing</em> a log rotate with this command (note the <code>-f</code> flag):</p><pre lang="bash">
logrotate -f /etc/logrotate.d/railsapp
</pre><h4 id="get-on-with-your-life">Get on with your life</h4><p>If that's worked, then huzzah! That should be one less thing to worry about when looking after a webapp - though the usual "do some real homework before putting absolute faith in and deploying on a production system" disclaimers apply. As ever with Linux, be sure to <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">read the man pages</a> before use.</p><p><em><em>nb.</em> While it's true that Rails is actually smart enough to rotate its own logs if you remember to configure it to behave this way, learning how to use <a href="http://gd.tuwien.ac.at/linuxcommand.org/man_pages/logrotate8.html" title="logrotate">logrotate</a> like this means we can use this on other apps too, without being too tied to a particular framework. Handy when you need it for a Merb, Sinatra, Django, or even Node.js project</em></p><!-- Links -->
</div>

<br/>


    
    <div id="prev-next">
    
    <a class="prev" href="/posts-output/2010-05-11-making-the-wordpress-source-code-something-youd-want-to-read/"><svg class="icon icon-circle-left"><use xlink:href="/img/icons.svg#icon-circle-left"></use></svg><div class="nav-text">Making the Wordpress source code something you&#39;d want to read</div></a>
    
    
    <a class="next" href="/posts-output/2010-05-10-setting-up-a-centos-base-box-for-development-and-testing-with-vagrant/"><div class="nav-text"">Setting up a CentOS base box for development and testing with Vagrant</div><svg class="icon icon-circle-right"><use xlink:href="/img/icons.svg#icon-circle-right"></use></svg></a>
    
</div>

    

</div>

            <hr/>
            <div id="footercont">
                Copyright &copy; 2020 Chris Adams
                <br>Powered by <a href="http://cryogenweb.org">Cryogen</a>
                <br>Theme by <a href="http://github.com/KingMob">KingMob</a>
            </div>
        </article>

        <script src="/js/highlight.pack.js" type="text/javascript"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        
        
    </body>
</html>
