<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Chris Adams Blog: How I am debugging Drupal Views </title>
        
<meta name="keywords" content="">

<meta name="description" content="I&#39;ve been working with Drupal a lot lately, and while there are lots of reasons to like it, ever now and then stumble across some ridiculously frustrating idiosyncrasy, that makes me want seriously consider working with the web professionally. I&#39;ve documented the process of debugging a recent view that took about a day in total of head scratching, swearing, and general unhappiness, so I can refer to it in future, when I&#39;m next battling with views, because I really don&#39;t ever want debugging to be this frustrating ever again.">

<meta property="og:description" content="I&#39;ve been working with Drupal a lot lately, and while there are lots of reasons to like it, ever now and then stumble across some ridiculously frustrating idiosyncrasy, that makes me want seriously consider working with the web professionally. I&#39;ve documented the process of debugging a recent view that took about a day in total of head scratching, swearing, and general unhappiness, so I can refer to it in future, when I&#39;m next battling with views, because I really don&#39;t ever want debugging to be this frustrating ever again.">

<meta property="og:url" content="http://blog.chrisadams.me.uk/posts-output/2010-09-12-how-i-am-debugging-drupal-views/" />
<meta property="og:title" content="How I am debugging Drupal Views " />
<meta property="og:type" content="article" />

        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Oxygen:300,400,700|Inconsolata" rel="stylesheet">
        <link href="/css/normalize.css" rel="stylesheet" type="text/css" />
        <link href="/css/blog.css" rel="stylesheet" type="text/css" />
        <link href="/css/lotus-highlightjs.min.css" rel="stylesheet" type="text/css" />

    </head>
    <body>
        <aside id="sidebar">
            <div id="logo">
                <a title="Chris Adams Blog" href="/">
                <div class="text desktop-and-tablet-only">Chris Adams Blog</div>
                <div class="text mobile-only">Chris Adams Blog</div>
                </a>
            </div>

            <nav id="sidebar-links">
                <nav id="menucont">
                    <input type="checkbox" id="menu-checkbox" class="menu-checkbox">
                    <label for="menu-checkbox" class="menutitle">
                        <svg class="icon icon-menu" aria-hidden="true"><use xlink:href="/img/icons.svg#icon-menu"></use></svg><span class="menu-text">Menu</span>
                    </label>
                    <ul class="menu">
                        <li ><a title="Home" href="/"><div class="menu-item-text">Home</div></a></li>
                        <li ><a title="Archives" href="/archives/"><div class="menu-item-text">Archives</div></a></li>
                        
                        
                        <li >
                            <a href="/pages-output/about/"><div class="menu-item-text">About</div></a>
                        </li>
                        
                        <!-- <li><a title="RSS" href="/feed.xml"><div class="menu-item-text">RSS</div></a></li> -->
                    </ul>
                </nav>

                <nav id="socialmedia">
                    <ul>
                        <li><a title="LinkedIn" href="https://www.linkedin.com/in/mrchrisadams" rel="external"><svg class="icon icon-linkedin"><use xlink:href="/img/icons.svg#icon-linkedin"></use></svg></a></li>
                        <li><a title="GitHub" href="https://github.com/mrchrisadams" rel="external"><svg class="icon icon-github-circled"><use xlink:href="/img/icons.svg#icon-github-circled"></use></svg></a></li>
                        <li><a title="RSS Feed" href="/feed.xml"><svg class="icon icon-rss-squared"><use xlink:href="/img/icons.svg#icon-rss-squared"></use></svg></a></li>
                    </ul>
                </nav>
            </nav>
        </aside>

        <article id="main">
            
<div id="post">
    <div class="post-header">
    <div id="post-meta">
        <h1>How I am debugging Drupal Views </h1>
        <div class="byline">
            <span class="date">September 12, 2010</span>
            
            <span class="author">By: admin</span>
            
        </div>
    </div>
</div>
<div>
    
    <!-- content below --><p>I've been working with Drupal a lot lately, and while there are lots of reasons to like it, ever now and then stumble across some ridiculously frustrating idiosyncrasy, that makes me want seriously consider working with the web professionally. I've documented the process of debugging a recent view that took about a day in total of head scratching, swearing, and general unhappiness, so I can refer to it in future, when I'm next battling with views, because I really don't ever want debugging to be this frustrating ever again.</p><p>The most recent time suck on mine has been working out why one view provided by the heartbeat module, was outputting content totally differently to how the rest of the site was. Here's the html I'd normally expect to see:</p><pre lang="html" line="1"><a href="http://project.work.local/node/166">joe bloggs</a> has <a href="http://project.work.local/node/166">added the page Multimedia Gallery</a></pre><p>Here's what was being generated.</p><pre lang="html" line="1">
  joebloggs [1] has added page Multimedia Gallery [2]. [1] http://project.work.local/users/joebloggs [2] http://project.work.local/node/166
</pre><p>Chucking that string into google brought lead me to the drupal function <code>drupal_html_to_text</code>, which you'd normally use to sanitise text before emailing people, but this function didn't seem to directly crop up in either the views code, nor the heartbeat code.</p><p>Running a call to <code>ack</code> to look for any occurrences of this string didn't help - I'd normally expect to see this function somewhere, in the two modules, but that brought up nothing.</p><p>Even throwing an exception before the variable was generated didn't show me where the text was being changed.</p><p>There's no logging that I know of to let me trace a request from hitting the server to coming out the other end to see what functions are touching it.</p><p>I was stuck.</p><h4 id="why-was-this-happening">Why was this happening?</h4><p>Eventually, I found out that I had the default input format set up wrong, which was the cause of all this pain. In this file here in the heartbeat module, <code>heartbeat/views/heartbeat_views.views.inc</code>, the view was reconstructing the output, basing it on what the default filter was, and handing it over to the <code>views_handler_field_markup</code> file for reformatting:</p><pre lang="php" line="108">

  // Heartbeat activity table
  $data['heartbeat_activity'] = array(

      // Table to join
      'table' =&gt; array(

        'group' =&gt; t('Heartbeat activity'),

        'base'  =&gt; array(
          'field' =&gt; 'message_id',
          'title' =&gt; t('Heartbeat activity messages'),
          'help'  =&gt; t("All activity logged by heartbeat"),
        ),
        /* 'join' =&gt; array(
          'heartbeat_messages' =&gt; array(
            'left_field' =&gt; 'message_id',
            'field' =&gt; 'message_id',
          ),
        ), */
      ),

  //  snip
  // pass content through the input filter before displaying it 
  'field' =&gt; array(
    'handler' =&gt; 'views_handler_field_markup',
    'format' =&gt; FILTER_FORMAT_DEFAULT,
  ),
  
</pre><p>In this <code>views/handlers/views_handler_field_markup.inc</code>  file, the text was being reformatted using the render function:</p><pre lang="php" line="28">

  function render($values) {
    $value = $values-&gt;{$this-&gt;field_alias};
    $format = is_numeric($this-&gt;format) ? $this-&gt;format : $values-&gt;{$this-&gt;aliases['format']};
    if ($value) {
      return check_markup($value, $format, FALSE);
    }
  }
  
</pre><p>... and herein lies the problem. My default format here was no longer <em>filtered html</em>, it was <em>messaging plain text</em>. If you see my defaults, you'll see why the links were being converted:</p><IMAGE here="here"><h3 id="how-to-solve-this-problem">How to solve this problem</h3><p>There are two ways you can solve this -</p><ol><li><p>You can change the default input format to allow links in the first pace. This keeps control in the database which works great for site builders who want to change content through the views UI.</p></li><li><p>You an override the template with code, and put it in source control.</p></li></ol><h4 id="solving-this-in-the-database">Solving this in the database</h4><p>In this case, our output finally ends up on our page via the default template <code>views-view-field.tpl.php</code> inside the views module which is visible below. The important variable to bear in mind here is <code>$output</code>, the result of all the prepocessing we define through the views UI, and whatever other part of Drupal decides to chime in in how it thinks the content should be rendered, like our input formatters.</p><pre lang="php" line="1">
  {$field-&gt;field_alias}
    *
    * The above will guarantee that you'll always get the correct data,
    * regardless of any changes in the aliasing that might happen if
    * the view is modified.
    */
  ?&gt;

  
  
</pre><p>After losing a day hunting down the source of this display issue, by spelunking through lot of Views and Activity contrib module code, countless blogposts and confusing views documentation, I think this is a terrible idea, especially if you're developing a website and you're already using source control, and you value consistency and simplicity.</p><h4 id="solving-this-in-code">Solving this in code</h4><p>The other way to solve this problem is to use an overriding template that the views UI is considerate enough to suggest the name for when settig up a view in the first place, and also let it generate a handy view template too. The output presented should look something like this:</p><p>This text is rendered using the render format here in <code>views-view-field--heartbeat-activity--block-1--message.tpl.php</code></p><pre lang="php" line="1">
  {$field-&gt;field_alias}
    *
    * The above will guarantee that you'll always get the correct data,
    * regardless of any changes in the aliasing that might happen if
    * the view is modified.
    */
  ?&gt;

  {$field-&gt;field_alias}; ?&gt;
  
</pre><p>The important change here now is that by default, we're not printing <code>$output</code> to the screen, but <code>$row-&gt;{$field-&gt;field_alias}</code>, which as the documentation tells us, is the content before it's been messed with by the input filters and such like. With direct control to the $row result, and its attributes, we finally have a degree of control over our layout, like we would be used to if using any other tool I'm more familiar with, like Rails, Django, or Wordpress.</p><p>The real watershed moment with this bug came when I gave up looking on Drupal.org, and used stack overflow to see if anyone else had had a similar problem, and following <a href="http://stackoverflow.com/questions/3538505/views-is-stripping-tags-from-the-output" title="Views is stripping tags from the output - Stack Overflow">links from an issue that looked very close to mine</a>.</p><p>Hopefully this will help someone else losing their hair when working on a drupal project, and help explain how this frustrating framework decides serve content to users using views.</p><p>This entire development process would be made so much easier if Drupal had an option to log the path through the framework a request takes, like how Rails does, so you can see which templates are being called, which queries are being made and so on.</p><p><em>Surely</em> there's a way to do this do you can see what Drupal is actually doing under the hood, instead of making so many semi-educated guesses like I had to do here?</p></IMAGE>
</div>

<br/>


    
    <div id="prev-next">
    
    <a class="prev" href="/posts-output/2010-09-19-discovering-the-jquery-data-method/"><svg class="icon icon-circle-left"><use xlink:href="/img/icons.svg#icon-circle-left"></use></svg><div class="nav-text">Discovering the jQuery data method</div></a>
    
    
    <a class="next" href="/posts-output/2010-08-24-how-to-tame-jives-backup-happy-nature/"><div class="nav-text"">How to tame Jive&#39;s backup happy nature</div><svg class="icon icon-circle-right"><use xlink:href="/img/icons.svg#icon-circle-right"></use></svg></a>
    
</div>

    

</div>

            <hr/>
            <div id="footercont">
                Copyright &copy; 2020 Chris Adams
                <br>Powered by <a href="http://cryogenweb.org">Cryogen</a>
                <br>Theme by <a href="http://github.com/KingMob">KingMob</a>
            </div>
        </article>

        <script src="/js/highlight.pack.js" type="text/javascript"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        
        
    </body>
</html>
